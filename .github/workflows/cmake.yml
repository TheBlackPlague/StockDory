name: CMake

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release

jobs:
  build:
    strategy:
      matrix:
        version: [ 0.1-ALPHA ]
        simd: [ sse, sse2, sse3, sse4.1, avx, avx2, avx512bw ]
        os: [ ubuntu-22.04 , windows-latest, macos-latest ]
        include:
          - os: windows-latest
            extension: .exe


    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v3

    - name: Prepare environment for Clang and Caching.
      run: |
        sudo apt install libncurses5 ninja-build

    - name: Install Clang 16
      uses: KyleMayes/install-llvm-action@v1.8.0
      with:
        ubuntu-version: "22.04"
        version: "16.0.3"
        force-version: true
        env: true

    - name: Configure CMake
      run: cmake -B ${{ github.workspace }}/build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DCMAKE_CXX_FLAGS="-m${{ matrix.simd }}" -G Ninja

    - name: Build
      run: cmake --build ${{ github.workspace }}/build --config ${{ env.BUILD_TYPE }}

    - name: Rename
      run: |
        mv ${{ github.workspace }}/build/StockDory${{ matrix.extension }} ${{ github.workspace }}/StockDory-${{ matrix.version }}-${{ matrix.os }}-${{ matrix.simd }}${{ matrix.extension }}

    - name: Upload
      uses: actions/upload-artifact@v2
      with:
        name: StockDory-${{ matrix.version }}-${{ matrix.os }}-${{ matrix.simd }}
        path: ${{ github.workspace }}/StockDory-${{ matrix.version }}-${{ matrix.os }}-${{ matrix.simd }}${{ matrix.extension }}

